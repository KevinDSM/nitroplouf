<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NITROPLOUF</title>
    <style>
        /* Styles CSS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            position: relative;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 36px;
            font-weight: bold;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .player-list {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .player {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            width: 180px;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .player.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.5);
        }
        .player input[type="checkbox"].select-player {
            display: none;
        }
        .player-name {
            font-weight: bold;
            margin-top: 10px;
        }
        .player-role {
            font-size: 14px;
            color: #666;
        }
        .secondary-role {
            margin-top: 5px;
            font-size: 13px;
        }
        .secondary-role input[type="checkbox"] {
            margin-right: 5px;
        }
        .dp-score {
            font-size: 13px;
            color: #444;
            display: none;
        }
        .btn {
            display: block;
            margin: 20px auto;
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #commandBtn {
            background-color: #000;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-top: 30px;
            padding: 0;
        }
        #commandBtn:hover {
            background-color: #333;
        }
        #commandTerminal {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        #commandInput {
            width: 80%;
            padding: 10px;
            font-size: 16px;
        }
        #result {
            margin-top: 30px;
        }
        .group {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .group h3 {
            margin-top: 0;
            text-align: center;
            color: #007bff;
        }
        .group table {
            width: 100%;
            border-collapse: collapse;
        }
        .group th, .group td {
            padding: 10px;
            text-align: left;
        }
        .group th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .group tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .group img {
            width: 150px;
            height: 150px;
            object-fit: cover;
        }
        .no-player {
            color: red;
            font-style: italic;
        }
        /* Style pour l'affichage de l'aide */
        #helpText {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #helpText h2 {
            text-align: center;
            color: #007bff;
        }
        #helpText ul {
            list-style-type: none;
            padding: 0;
        }
        #helpText li {
            margin-bottom: 10px;
        }
        #helpText strong {
            color: #007bff;
        }
        /* Style pour le lien de téléchargement */
        #downloadLink {
            position: absolute;
            bottom: 10px;
            right: 10px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        #downloadLink:hover {
            color: #0056b3;
        }
    </style>
</head>
<body>

<h1>NITROPLOUF</h1>

<div class="controls">
    <label for="sortSelect">Trier les joueurs par :</label>
    <select id="sortSelect" onchange="generatePlayerList()">
        <option value="name">Ordre Alphabétique</option>
        <option value="role">Rôle</option>
    </select>
</div>

<div class="player-list" id="playerForm"></div>

<button class="btn" onclick="generateGroups()">Lancer le Plouf Plouf</button>

<button class="btn" id="commandBtn" onclick="toggleCommandTerminal()"></button>

<div id="commandTerminal">
    <input type="text" id="commandInput" placeholder="Entrez une commande..." onkeydown="handleCommand(event)">
</div>

<div id="result"></div>

<a id="downloadLink" href="https://drive.google.com/file/d/19ko5ZBbUlOZySxhzHeRAH6Hp256wWARt/view" target="_blank">Télécharger Houineaura</a>

<script>
    let dpMode = false;
    let showDp = false;
    let showGifs = false;
    let forcedPlayers = [];
    const defaultDpValues = {};

    const players = [
        {name: 'Champka', mainRole: 'Heal', dp: 0, realName: 'Champka'},
        {name: 'Choràn', mainRole: 'DPS', dp: 0, realName: 'Choràn'},
        // Liste des joueurs...
    ];

    players.forEach(player => {
        defaultDpValues[player.name] = player.dp;
    });

    // Mapping des joueurs aux noms de leurs GIFs
    const playerGifs = {
        'Champka': 'Champka.gif',
        'Choràn': 'Choren.gif',
        // Autres GIFs...
    };

    async function updateDpWithRioScores() {
        const promises = players.map(async (player) => {
            try {
                const response = await fetch(`https://raider.io/api/v1/characters/profile?region=eu&realm=hyjal&name=${encodeURIComponent(player.realName)}&fields=mythic_plus_scores_by_season:current`);
                if (response.ok) {
                    const data = await response.json();
                    const rioScore = data.mythic_plus_scores_by_season[0].scores.all || 0;
                    player.dp = Math.round(rioScore);
                    defaultDpValues[player.name] = player.dp;
                } else {
                    player.dp = 0; // Valeur par défaut si l'API ne renvoie pas de résultat
                }
            } catch {
                player.dp = 0; // Valeur par défaut en cas d'erreur réseau
            }
        });
        await Promise.all(promises);
        generatePlayerList(); // Met à jour l'affichage avec les nouveaux DP
    }

    function generatePlayerList() {
        const sortOption = document.getElementById('sortSelect').value;
        const playerForm = document.getElementById('playerForm');
        playerForm.innerHTML = '';

        let sortedPlayers = [...players];

        if (sortOption === 'name') {
            sortedPlayers.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortOption === 'role') {
            const roleOrder = {'Tank': 1, 'Heal': 2, 'DPS': 3};
            sortedPlayers.sort((a, b) => {
                const roleA = a.mainRole;
                const roleB = b.mainRole;
                if (roleA === roleB) {
                    return a.name.localeCompare(b.name);
                } else {
                    return roleOrder[roleA] - roleOrder[roleB];
                }
            });
        }

        sortedPlayers.forEach((player) => {
            const div = document.createElement('div');
            div.className = 'player';
            div.dataset.playerName = player.name;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-player';
            checkbox.id = 'player-' + player.name;
            checkbox.name = 'players';
            checkbox.value = player.name;

            const nameSpan = document.createElement('div');
            nameSpan.className = 'player-name';
            nameSpan.textContent = player.name;

            const roleSpan = document.createElement('div');
            roleSpan.className = 'player-role';
            roleSpan.textContent = `Rôle principal : ${player.mainRole}`;

            div.appendChild(checkbox);
            div.appendChild(nameSpan);
            div.appendChild(roleSpan);

            if (showDp) {
                const dpSpan = document.createElement('div');
                dpSpan.className = 'dp-score';
                dpSpan.textContent = `Score RIO : ${player.dp}`;
                dpSpan.style.display = 'block';
                div.appendChild(dpSpan);
            }

            if (player.secondaryRole) {
                const secondaryDiv = document.createElement('div');
                secondaryDiv.className = 'secondary-role';

                const secondaryCheckbox = document.createElement('input');
                secondaryCheckbox.type = 'checkbox';
                secondaryCheckbox.id = 'secondary-' + player.name;
                secondaryCheckbox.name = 'secondary-' + player.name;
                secondaryCheckbox.value = 'true';

                const secondaryLabel = document.createElement('label');
                secondaryLabel.htmlFor = 'secondary-' + player.name;
                secondaryLabel.innerHTML = `Utiliser spé secondaire (${player.secondaryRole})`;

                secondaryDiv.appendChild(secondaryCheckbox);
                secondaryDiv.appendChild(secondaryLabel);

                div.appendChild(secondaryDiv);
            }

            div.addEventListener('click', function(e) {
                if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'label') {
                    return;
                }
                checkbox.checked = !checkbox.checked;
                div.classList.toggle('selected', checkbox.checked);
            });

            checkbox.addEventListener('change', function() {
                div.classList.toggle('selected', checkbox.checked);
            });

            // Événement clic droit pour ouvrir la page Raider.IO
            div.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                window.open(`https://raider.io/characters/eu/hyjal/${encodeURIComponent(player.realName)}`, '_blank');
            });

            playerForm.appendChild(div);
        });
    }

    updateDpWithRioScores();

    function generateGroups() {
        const selectedPlayers = [];
        const playerCheckboxes = document.querySelectorAll('input.select-player:checked');
        playerCheckboxes.forEach((checkbox) => {
            const playerName = checkbox.value;
            const player = players.find(p => p.name === playerName);
            if (player) {
                const secondaryCheckbox = document.getElementById('secondary-' + player.name);
                const roleUsed = secondaryCheckbox && secondaryCheckbox.checked ? player.secondaryRole : player.mainRole;
                selectedPlayers.push({...player, roleUsed});
            }
        });

        if (selectedPlayers.length === 0) {
            alert('Veuillez sélectionner au moins un joueur.');
            return;
        }

        const groups = [];
        for (let i = 0; i < Math.max(1, Math.ceil(selectedPlayers.length / 3)); i++) {
            groups.push({
                Tank: null,
                Heal: null,
                DPS: [],
                totalDp: 0,
                members: []
            });
        }

        selectedPlayers.forEach(player => {
            const group = groups.find(g => !g[player.roleUsed]) || groups[0];
            group[player.roleUsed] = player;
            group.members.push(player);
            group.totalDp += player.dp;
        });

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';

            const groupTitle = document.createElement('h3');
            groupTitle.textContent = `Groupe ${index + 1}`;
            groupDiv.appendChild(groupTitle);

            const table = document.createElement('table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const thName = document.createElement('th');
            thName.textContent = 'Joueur';
            const thRole = document.createElement('th');
            thRole.textContent = 'Rôle';
            headerRow.appendChild(thName);
            headerRow.appendChild(thRole);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            if (group.Tank) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                if (showGifs) {
                    const gifImg = document.createElement('img');
                    gifImg.src = getGifForPlayer(group.Tank.name);
                    gifImg.alt = group.Tank.name;
                    gifImg.style.width = '150px';
                    gifImg.style.height = '150px';
                    gifImg.style.objectFit = 'cover';
                    cellName.appendChild(gifImg);
                } else {
                    cellName.textContent = group.Tank.name;
                }
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Tank';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            if (group.Heal) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                if (showGifs) {
                    const gifImg = document.createElement('img');
                    gifImg.src = getGifForPlayer(group.Heal.name);
                    gifImg.alt = group.Heal.name;
                    gifImg.style.width = '150px';
                    gifImg.style.height = '150px';
                    gifImg.style.objectFit = 'cover';
                    cellName.appendChild(gifImg);
                } else {
                    cellName.textContent = group.Heal.name;
                }
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Heal';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            group.DPS.forEach(player => {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                if (showGifs) {
                    const gifImg = document.createElement('img');
                    gifImg.src = getGifForPlayer(player.name);
                    gifImg.alt = player.name;
                    gifImg.style.width = '150px';
                    gifImg.style.height = '150px';
                    gifImg.style.objectFit = 'cover';
                    cellName.appendChild(gifImg);
                } else {
                    cellName.textContent = player.name;
                }
                const cellRole = document.createElement('td');
                cellRole.textContent = 'DPS';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            groupDiv.appendChild(table);

            resultDiv.appendChild(groupDiv);
        });
    }

    function getGifForPlayer(playerName) {
        return playerGifs[playerName] || '';
    }
</script>

</body>
</html>
