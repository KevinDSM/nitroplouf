<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Plouf Plouf - Répartition des Groupes</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .player-list {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .player {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            width: 180px;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .player.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.5);
        }
        .player input[type="checkbox"].select-player {
            display: none;
        }
        .player-name {
            font-weight: bold;
            margin-top: 10px;
        }
        .player-role {
            font-size: 14px;
            color: #666;
        }
        .secondary-role {
            margin-top: 5px;
            font-size: 13px;
        }
        .secondary-role input[type="checkbox"] {
            margin-right: 5px;
        }
        .dp-score {
            font-size: 13px;
            color: #444;
            display: none;
        }
        .btn {
            display: block;
            margin: 20px auto;
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #commandBtn {
            background-color: #000;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-top: 30px;
            padding: 0;
        }
        #commandBtn:hover {
            background-color: #333;
        }
        #commandTerminal {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        #commandInput {
            width: 80%;
            padding: 10px;
            font-size: 16px;
        }
        #result {
            margin-top: 30px;
        }
        .group {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .group h3 {
            margin-top: 0;
            text-align: center;
            color: #007bff;
        }
        .group table {
            width: 100%;
            border-collapse: collapse;
        }
        .group th, .group td {
            padding: 10px;
            text-align: left;
        }
        .group th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .group tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .no-player {
            color: red;
            font-style: italic;
        }
    </style>
</head>
<body>

<h1>Plouf Plouf - Répartition des Groupes</h1>

<div class="player-list" id="playerForm"></div>

<button class="btn" onclick="generateGroups()">Lancer le Plouf Plouf</button>

<button class="btn" id="commandBtn" onclick="toggleCommandTerminal()"></button>

<div id="commandTerminal">
    <input type="text" id="commandInput" placeholder="Entrez une commande..." onkeydown="handleCommand(event)">
</div>

<div id="result"></div>

<script>
    let dpMode = false;
    let showDp = false;
    let cheatPlayers = [];
    const defaultDpValues = {};

    const players = [
        {name: 'Houine', mainRole: 'Tank', dp: 8},
        {name: 'Roukii', mainRole: 'DPS', dp: 8},
        {name: 'Toto', mainRole: 'DPS', dp: 8},
        {name: 'Kri', mainRole: 'DPS', secondaryRole: 'Tank', dp: 8},
        {name: 'Champka', mainRole: 'Heal', dp: 8},
        {name: 'Sindo', mainRole: 'DPS', secondaryRole: 'Tank', dp: 7},
        {name: 'Kuro', mainRole: 'DPS', dp: 6},
        {name: 'Insta', mainRole: 'Heal', secondaryRole: 'DPS', dp: 5},
        {name: 'Percy', mainRole: 'Heal', dp: 6},
        {name: 'Foyn', mainRole: 'DPS', dp: 4},
        {name: 'Eistre', mainRole: 'DPS', dp: 5},
        {name: 'Degun', mainRole: 'DPS', dp: 5},
        {name: 'Filé', mainRole: 'DPS', dp: 3},
        {name: 'Fenrir', mainRole: 'DPS', dp: 5},
        {name: 'Pasici', mainRole: 'DPS', secondaryRole: 'Heal', dp: 8},
        {name: 'Shoren', mainRole: 'DPS', dp: 4},
        {name: 'Kiroy', mainRole: 'DPS', dp: 3}
    ];

    players.forEach(player => {
        defaultDpValues[player.name] = player.dp;
    });

    function generatePlayerList() {
        playerForm.innerHTML = '';
        players.forEach((player, index) => {
            const div = document.createElement('div');
            div.className = 'player';
            div.dataset.index = index;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-player';
            checkbox.id = 'player' + index;
            checkbox.name = 'players';
            checkbox.value = index;

            const nameSpan = document.createElement('div');
            nameSpan.className = 'player-name';
            nameSpan.textContent = player.name;

            const roleSpan = document.createElement('div');
            roleSpan.className = 'player-role';
            roleSpan.textContent = `Rôle principal : ${player.mainRole}`;

            div.appendChild(checkbox);
            div.appendChild(nameSpan);
            div.appendChild(roleSpan);

            if (showDp) {
                const dpSpan = document.createElement('div');
                dpSpan.className = 'dp-score';
                dpSpan.textContent = `DP : ${player.dp}`;
                dpSpan.style.display = 'block';
                div.appendChild(dpSpan);
            }

            if (player.secondaryRole) {
                const secondaryDiv = document.createElement('div');
                secondaryDiv.className = 'secondary-role';

                const secondaryCheckbox = document.createElement('input');
                secondaryCheckbox.type = 'checkbox';
                secondaryCheckbox.id = 'secondary' + index;
                secondaryCheckbox.name = 'secondary' + index;
                secondaryCheckbox.value = 'true';

                const secondaryLabel = document.createElement('label');
                secondaryLabel.htmlFor = 'secondary' + index;
                secondaryLabel.innerHTML = `Utiliser spé secondaire (${player.secondaryRole})`;

                secondaryDiv.appendChild(secondaryCheckbox);
                secondaryDiv.appendChild(secondaryLabel);

                div.appendChild(secondaryDiv);
            }

            div.addEventListener('click', function(e) {
                if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'label') {
                    return;
                }
                checkbox.checked = !checkbox.checked;
                div.classList.toggle('selected', checkbox.checked);
            });

            checkbox.addEventListener('change', function() {
                div.classList.toggle('selected', checkbox.checked);
            });

            playerForm.appendChild(div);
        });
    }

    const playerForm = document.getElementById('playerForm');
    generatePlayerList();

    function shuffle(array) {
        array.sort(() => Math.random() - 0.5);
    }

    function generateGroups() {
        const selectedPlayers = [];
        players.forEach((player, index) => {
            const playerCheckbox = document.getElementById('player' + index);
            if (playerCheckbox.checked) {
                const secondaryCheckbox = document.getElementById('secondary' + index);
                selectedPlayers.push({...player, useSecondary: secondaryCheckbox ? secondaryCheckbox.checked : false});
            }
        });

        if (selectedPlayers.length === 0) {
            alert('Veuillez sélectionner au moins un joueur.');
            return;
        }

        let totalPlayers = selectedPlayers.length;
        let maxGroupSize = 5;
        let minGroupSize = 4;
        let numGroups = Math.floor(totalPlayers / maxGroupSize);
        if (totalPlayers % maxGroupSize !== 0) {
            numGroups += 1;
        }
        while (totalPlayers / numGroups < minGroupSize) {
            numGroups += 1;
        }

        const groups = [];
        for (let i = 0; i < numGroups; i++) {
            groups.push({Tank: null, Heal: null, DPS: [], members: [], totalDp: 0});
        }

        if (cheatPlayers.length > 0) {
            const firstGroup = groups[0];
            cheatPlayers.forEach(playerName => {
                const playerIndex = selectedPlayers.findIndex(p => p.name.toLowerCase() === playerName.toLowerCase());
                if (playerIndex !== -1) {
                    const player = selectedPlayers.splice(playerIndex, 1)[0];
                    if ((player.mainRole === 'Tank' && !player.useSecondary) || (player.useSecondary && player.secondaryRole === 'Tank')) {
                        if (!firstGroup.Tank) {
                            firstGroup.Tank = player;
                        } else {
                            firstGroup.DPS.push(player);
                        }
                    } else if ((player.mainRole === 'Heal' && !player.useSecondary) || (player.useSecondary && player.secondaryRole === 'Heal')) {
                        if (!firstGroup.Heal) {
                            firstGroup.Heal = player;
                        } else {
                            firstGroup.DPS.push(player);
                        }
                    } else {
                        firstGroup.DPS.push(player);
                    }
                    firstGroup.members.push(player);
                    firstGroup.totalDp += player.dp;
                }
            });
        }

        let tanks = selectedPlayers.filter(p => (p.mainRole === 'Tank' && !p.useSecondary) || (p.useSecondary && p.secondaryRole === 'Tank'));
        let heals = selectedPlayers.filter(p => (p.mainRole === 'Heal' && !p.useSecondary) || (p.useSecondary && p.secondaryRole === 'Heal'));
        let dps = selectedPlayers.filter(p => (p.mainRole === 'DPS' && !p.useSecondary) || (p.useSecondary && p.secondaryRole === 'DPS'));

        shuffle(tanks);
        shuffle(heals);
        shuffle(dps);

        let tankIndex = 0;
        for (let i = 0; i < groups.length; i++) {
            if (!groups[i].Tank && tankIndex < tanks.length) {
                groups[i].Tank = tanks[tankIndex];
                groups[i].members.push(tanks[tankIndex]);
                groups[i].totalDp += tanks[tankIndex].dp;
                tankIndex++;
            }
        }

        let healIndex = 0;
        for (let i = 0; i < groups.length; i++) {
            if (!groups[i].Heal && healIndex < heals.length) {
                groups[i].Heal = heals[healIndex];
                groups[i].members.push(heals[healIndex]);
                groups[i].totalDp += heals[healIndex].dp;
                healIndex++;
            }
        }

        if (dpMode) {
            dps.sort((a, b) => b.dp - a.dp);
            dps.forEach(player => {
                groups.sort((a, b) => a.totalDp - b.totalDp);
                groups[0].DPS.push(player);
                groups[0].members.push(player);
                groups[0].totalDp += player.dp;
            });
        } else {
            let dpsIndex = 0;
            while (dpsIndex < dps.length) {
                for (let i = 0; i < groups.length; i++) {
                    if (dpsIndex >= dps.length) break;
                    groups[i].DPS.push(dps[dpsIndex]);
                    groups[i].members.push(dps[dpsIndex]);
                    dpsIndex++;
                }
            }
        }

        let needAdjustment = true;
        while (needAdjustment) {
            needAdjustment = false;
            groups.sort((a, b) => b.members.length - a.members.length);
            let groupMax = groups[0];
            let groupMin = groups[groups.length - 1];
            if (groupMax.members.length - groupMin.members.length > 1) {
                let playerToMove = groupMax.DPS.pop();
                if (!playerToMove) {
                    if (groupMax.Heal && !groupMin.Heal) {
                        playerToMove = groupMax.Heal;
                        groupMax.Heal = null;
                        groupMin.Heal = playerToMove;
                    } else if (groupMax.Tank && !groupMin.Tank) {
                        playerToMove = groupMax.Tank;
                        groupMax.Tank = null;
                        groupMin.Tank = playerToMove;
                    } else {
                        break;
                    }
                }
                groupMax.members.splice(groupMax.members.indexOf(playerToMove), 1);
                groupMax.totalDp -= playerToMove.dp;
                groupMin.members.push(playerToMove);
                groupMin.totalDp += playerToMove.dp;
                if ((playerToMove.mainRole === 'DPS' && !playerToMove.useSecondary) || (playerToMove.useSecondary && playerToMove.secondaryRole === 'DPS')) {
                    groupMin.DPS.push(playerToMove);
                } else if ((playerToMove.mainRole === 'Heal' && !playerToMove.useSecondary) || (playerToMove.useSecondary && playerToMove.secondaryRole === 'Heal')) {
                    groupMin.Heal = playerToMove;
                } else if ((playerToMove.mainRole === 'Tank' && !playerToMove.useSecondary) || (playerToMove.useSecondary && playerToMove.secondaryRole === 'Tank')) {
                    groupMin.Tank = playerToMove;
                }
                needAdjustment = true;
            }
        }

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';

            const groupTitle = document.createElement('h3');
            groupTitle.textContent = `Groupe ${index + 1}`;
            groupDiv.appendChild(groupTitle);

            const table = document.createElement('table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const thName = document.createElement('th');
            thName.textContent = 'Joueur';
            const thRole = document.createElement('th');
            thRole.textContent = 'Rôle';
            headerRow.appendChild(thName);
            headerRow.appendChild(thRole);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            if (group.Tank) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = group.Tank.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Tank';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            if (group.Heal) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = group.Heal.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Heal';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            group.DPS.forEach(player => {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = player.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'DPS';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            groupDiv.appendChild(table);

            resultDiv.appendChild(groupDiv);
        });
    }

    function toggleCommandTerminal() {
        const terminal = document.getElementById('commandTerminal');
        terminal.style.display = terminal.style.display === 'none' ? 'block' : 'none';
        document.getElementById('commandInput').focus();
    }

    function handleCommand(event) {
        if (event.key === 'Enter') {
            const input = event.target.value.trim();
            const command = input.toLowerCase();
            const args = input.split(' ');

            if (command.startsWith('change dp ')) {
                if (args.length >= 4) {
                    const playerName = args[2];
                    const newDp = parseInt(args[3], 10);
                    if (!isNaN(newDp)) {
                        const player = players.find(p => p.name.toLowerCase() === playerName.toLowerCase());
                        if (player) {
                            player.dp = newDp;
                            alert(`DP de ${player.name} mis à jour à ${newDp}.`);
                            if (showDp) {
                                generatePlayerList();
                            }
                        } else {
                            alert(`Joueur ${playerName} non trouvé.`);
                        }
                    } else {
                        alert('Veuillez spécifier une valeur numérique pour le DP.');
                    }
                } else {
                    alert('Usage : change dp NomDuJoueur NouvelleValeurDP');
                }
            } else if (command === 'no change dp') {
                players.forEach(player => {
                    player.dp = defaultDpValues[player.name];
                });
                alert('Les DP ont été réinitialisés aux valeurs par défaut.');
                if (showDp) {
                    generatePlayerList();
                }
            } else if (command.startsWith('cheat ')) {
                cheatPlayers = args.slice(1).map(name => name.toLowerCase());
                alert(`Cheat activé pour les joueurs : ${cheatPlayers.join(', ')}.`);
            } else if (command === 'dp') {
                dpMode = true;
                alert('Mode DP activé. Les groupes seront équilibrés en fonction des points DP.');
            } else if (command === 'show dp' || command === 'showdp') {
                showDp = true;
                generatePlayerList();
            } else if (command === 'no dp') {
                dpMode = false;
                alert('Mode DP désactivé.');
            } else if (command === 'no show dp' || command === 'noshow dp' || command === 'no showdp' || command === 'noshowdp') {
                showDp = false;
                generatePlayerList();
            } else {
                alert('Commande non reconnue.');
            }
            event.target.value = '';
        }
    }
</script>

</body>
</html>
