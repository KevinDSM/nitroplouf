<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Plouf Plouf - Répartition des Groupes</title>
    <style>
        /* Styles CSS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .player-list {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .player {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            width: 180px;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .player.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.5);
        }
        .player input[type="checkbox"].select-player {
            display: none;
        }
        .player-name {
            font-weight: bold;
            margin-top: 10px;
        }
        .player-role {
            font-size: 14px;
            color: #666;
        }
        .secondary-role {
            margin-top: 5px;
            font-size: 13px;
        }
        .secondary-role input[type="checkbox"] {
            margin-right: 5px;
        }
        .dp-score {
            font-size: 13px;
            color: #444;
            display: none;
        }
        .btn {
            display: block;
            margin: 20px auto;
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #commandBtn {
            background-color: #000;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-top: 30px;
            padding: 0;
        }
        #commandBtn:hover {
            background-color: #333;
        }
        #commandTerminal {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        #commandInput {
            width: 80%;
            padding: 10px;
            font-size: 16px;
        }
        #result {
            margin-top: 30px;
        }
        .group {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .group h3 {
            margin-top: 0;
            text-align: center;
            color: #007bff;
        }
        .group table {
            width: 100%;
            border-collapse: collapse;
        }
        .group th, .group td {
            padding: 10px;
            text-align: left;
        }
        .group th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .group tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .no-player {
            color: red;
            font-style: italic;
        }
    </style>
</head>
<body>

<h1>Plouf Plouf - Répartition des Groupes</h1>

<div class="player-list" id="playerForm"></div>

<button class="btn" onclick="generateGroups()">Lancer le Plouf Plouf</button>

<button class="btn" id="commandBtn" onclick="toggleCommandTerminal()"></button>

<div id="commandTerminal">
    <input type="text" id="commandInput" placeholder="Entrez une commande..." onkeydown="handleCommand(event)">
</div>

<div id="result"></div>

<script>
    let dpMode = false;
    let showDp = false;
    let forcedPlayers = [];
    const defaultDpValues = {};

    const players = [
        {name: 'Houine', mainRole: 'Tank', dp: 8},
        {name: 'Roukii', mainRole: 'DPS', dp: 8},
        {name: 'Toto', mainRole: 'DPS', dp: 8},
        {name: 'Kri', mainRole: 'DPS', secondaryRole: 'Tank', dp: 8},
        {name: 'Champka', mainRole: 'Heal', dp: 8},
        {name: 'Sindo', mainRole: 'DPS', secondaryRole: 'Tank', dp: 7},
        {name: 'Kuro', mainRole: 'DPS', dp: 6},
        {name: 'Insta', mainRole: 'Heal', secondaryRole: 'DPS', dp: 5},
        {name: 'Percy', mainRole: 'Heal', dp: 6},
        {name: 'Foyn', mainRole: 'DPS', dp: 4},
        {name: 'Eistre', mainRole: 'DPS', dp: 5},
        {name: 'Degun', mainRole: 'DPS', dp: 5},
        {name: 'Filé', mainRole: 'DPS', dp: 3},
        {name: 'Fenrir', mainRole: 'DPS', dp: 5},
        {name: 'Pasici', mainRole: 'DPS', secondaryRole: 'Heal', dp: 8},
        {name: 'Shoren', mainRole: 'DPS', dp: 4},
        {name: 'Kiroy', mainRole: 'DPS', dp: 3}
    ];

    players.forEach(player => {
        defaultDpValues[player.name] = player.dp;
    });

    function generatePlayerList() {
        const playerForm = document.getElementById('playerForm');
        playerForm.innerHTML = '';
        players.forEach((player, index) => {
            const div = document.createElement('div');
            div.className = 'player';
            div.dataset.index = index;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-player';
            checkbox.id = 'player' + index;
            checkbox.name = 'players';
            checkbox.value = index;

            const nameSpan = document.createElement('div');
            nameSpan.className = 'player-name';
            nameSpan.textContent = player.name;

            const roleSpan = document.createElement('div');
            roleSpan.className = 'player-role';
            roleSpan.textContent = `Rôle principal : ${player.mainRole}`;

            div.appendChild(checkbox);
            div.appendChild(nameSpan);
            div.appendChild(roleSpan);

            if (showDp) {
                const dpSpan = document.createElement('div');
                dpSpan.className = 'dp-score';
                dpSpan.textContent = `DP : ${player.dp}`;
                dpSpan.style.display = 'block';
                div.appendChild(dpSpan);
            }

            if (player.secondaryRole) {
                const secondaryDiv = document.createElement('div');
                secondaryDiv.className = 'secondary-role';

                const secondaryCheckbox = document.createElement('input');
                secondaryCheckbox.type = 'checkbox';
                secondaryCheckbox.id = 'secondary' + index;
                secondaryCheckbox.name = 'secondary' + index;
                secondaryCheckbox.value = 'true';

                const secondaryLabel = document.createElement('label');
                secondaryLabel.htmlFor = 'secondary' + index;
                secondaryLabel.innerHTML = `Utiliser spé secondaire (${player.secondaryRole})`;

                secondaryDiv.appendChild(secondaryCheckbox);
                secondaryDiv.appendChild(secondaryLabel);

                div.appendChild(secondaryDiv);
            }

            div.addEventListener('click', function(e) {
                if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'label') {
                    return;
                }
                checkbox.checked = !checkbox.checked;
                div.classList.toggle('selected', checkbox.checked);
            });

            checkbox.addEventListener('change', function() {
                div.classList.toggle('selected', checkbox.checked);
            });

            playerForm.appendChild(div);
        });
    }

    generatePlayerList();

    function shuffle(array) {
        array.sort(() => Math.random() - 0.5);
    }

    function generateGroups() {
        const selectedPlayers = [];
        players.forEach((player, index) => {
            const playerCheckbox = document.getElementById('player' + index);
            if (playerCheckbox && playerCheckbox.checked) {
                const secondaryCheckbox = document.getElementById('secondary' + index);
                selectedPlayers.push({...player, useSecondary: secondaryCheckbox ? secondaryCheckbox.checked : false});
            }
        });

        if (selectedPlayers.length === 0) {
            alert('Veuillez sélectionner au moins un joueur.');
            return;
        }

        // Séparer les joueurs par rôle, en priorisant les rôles principaux
        let tanks = selectedPlayers.filter(p => p.mainRole === 'Tank' && !p.useSecondary);
        let heals = selectedPlayers.filter(p => p.mainRole === 'Heal' && !p.useSecondary);
        let dps = selectedPlayers.filter(p => p.mainRole === 'DPS' && !p.useSecondary);

        // Ajouter les joueurs en spé secondaire si nécessaire
        let secondaryTanks = selectedPlayers.filter(p => p.useSecondary && p.secondaryRole === 'Tank');
        let secondaryHeals = selectedPlayers.filter(p => p.useSecondary && p.secondaryRole === 'Heal');
        let secondaryDps = selectedPlayers.filter(p => p.useSecondary && p.secondaryRole === 'DPS');

        // Calculer le nombre de groupes nécessaires
        const maxDpsPerGroup = 3;
        const numHeals = heals.length + secondaryHeals.length;
        const numDps = dps.length + secondaryDps.length;

        let numGroups = Math.ceil(numDps / maxDpsPerGroup);
        numGroups = Math.max(numGroups, heals.length);

        if (heals.length + secondaryHeals.length < numGroups) {
            alert('Pas assez de Heals pour remplir tous les groupes. Veuillez activer des spés secondaires pour les Heals ou réduire le nombre de DPS.');
            return;
        }

        const groups = [];
        for (let i = 0; i < numGroups; i++) {
            groups.push({Tank: null, Heal: null, DPS: [], members: [], totalDp: 0});
        }

        // Forcer les joueurs spécifiés dans le premier groupe
        if (forcedPlayers.length > 0) {
            const firstGroup = groups[0];
            forcedPlayers.forEach(playerName => {
                const playerIndex = selectedPlayers.findIndex(p => p.name.toLowerCase() === playerName.toLowerCase());
                if (playerIndex !== -1) {
                    const player = selectedPlayers.splice(playerIndex, 1)[0];
                    if (player.useSecondary) {
                        player.roleUsed = player.secondaryRole;
                    } else {
                        player.roleUsed = player.mainRole;
                    }
                    if (player.roleUsed === 'Tank' && !firstGroup.Tank) {
                        firstGroup.Tank = player;
                    } else if (player.roleUsed === 'Heal' && !firstGroup.Heal) {
                        firstGroup.Heal = player;
                    } else {
                        firstGroup.DPS.push(player);
                    }
                    firstGroup.members.push(player);
                    if (dpMode) {
                        firstGroup.totalDp += player.dp;
                    }
                }
            });
        }

        // Affecter les Heals principaux
        heals.forEach((heal, index) => {
            const groupIndex = index % numGroups;
            if (!groups[groupIndex].Heal) {
                groups[groupIndex].Heal = heal;
                groups[groupIndex].members.push(heal);
                if (dpMode) {
                    groups[groupIndex].totalDp += heal.dp;
                }
            }
        });

        // Affecter les Heals secondaires si nécessaire
        if (heals.length < numGroups) {
            secondaryHeals.forEach((heal) => {
                for (let i = 0; i < numGroups; i++) {
                    if (!groups[i].Heal) {
                        groups[i].Heal = heal;
                        groups[i].members.push(heal);
                        if (dpMode) {
                            groups[i].totalDp += heal.dp;
                        }
                        break;
                    }
                }
            });
        }

        // Affecter les Tanks principaux
        tanks.forEach((tank, index) => {
            const groupIndex = index % numGroups;
            if (!groups[groupIndex].Tank) {
                groups[groupIndex].Tank = tank;
                groups[groupIndex].members.push(tank);
                if (dpMode) {
                    groups[groupIndex].totalDp += tank.dp;
                }
            }
        });

        // Affecter les Tanks secondaires si nécessaire
        if (tanks.length < numGroups) {
            secondaryTanks.forEach((tank) => {
                for (let i = 0; i < numGroups; i++) {
                    if (!groups[i].Tank) {
                        groups[i].Tank = tank;
                        groups[i].members.push(tank);
                        if (dpMode) {
                            groups[i].totalDp += tank.dp;
                        }
                        break;
                    }
                }
            });
        }

        // Répartir les DPS
        let allDps = dps.concat(secondaryDps);
        if (dpMode) {
            allDps.sort((a, b) => b.dp - a.dp);
        } else {
            shuffle(allDps);
        }

        let groupIndex = 0;
        allDps.forEach(dpsPlayer => {
            if (groups[groupIndex].DPS.length >= maxDpsPerGroup) {
                groupIndex = (groupIndex + 1) % numGroups;
            }
            groups[groupIndex].DPS.push(dpsPlayer);
            groups[groupIndex].members.push(dpsPlayer);
            if (dpMode) {
                groups[groupIndex].totalDp += dpsPlayer.dp;
            }
            groupIndex = (groupIndex + 1) % numGroups;
        });

        // Vérifier le nombre de DPS par groupe
        for (let i = 0; i < groups.length; i++) {
            if (groups[i].DPS.length > maxDpsPerGroup) {
                alert(`Le groupe ${i + 1} a plus de ${maxDpsPerGroup} DPS. Veuillez vérifier les sélections.`);
                return;
            }
        }

        // Affichage des groupes
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';

            const groupTitle = document.createElement('h3');
            groupTitle.textContent = `Groupe ${index + 1}`;
            groupDiv.appendChild(groupTitle);

            const table = document.createElement('table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const thName = document.createElement('th');
            thName.textContent = 'Joueur';
            const thRole = document.createElement('th');
            thRole.textContent = 'Rôle';
            headerRow.appendChild(thName);
            headerRow.appendChild(thRole);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            if (group.Tank) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = group.Tank.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Tank';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            if (group.Heal) {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = group.Heal.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'Heal';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            }

            group.DPS.forEach(player => {
                const row = document.createElement('tr');
                const cellName = document.createElement('td');
                cellName.textContent = player.name;
                const cellRole = document.createElement('td');
                cellRole.textContent = 'DPS';
                row.appendChild(cellName);
                row.appendChild(cellRole);
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            groupDiv.appendChild(table);

            resultDiv.appendChild(groupDiv);
        });
    }

    function toggleCommandTerminal() {
        const terminal = document.getElementById('commandTerminal');
        terminal.style.display = terminal.style.display === 'none' ? 'block' : 'none';
        document.getElementById('commandInput').focus();
    }

    function handleCommand(event) {
        if (event.key === 'Enter') {
            const input = event.target.value.trim();
            const args = input.split(' ');
            const command = args[0].toLowerCase();

            if (command === 'cheat') {
                forcedPlayers = args.slice(1).map(name => name.toLowerCase());
                alert(`Les joueurs suivants seront placés dans le premier groupe : ${forcedPlayers.join(', ')}.`);
            } else if (command === 'dp') {
                dpMode = true;
                alert('Mode DP activé. Les groupes seront équilibrés en fonction des points DP.');
            } else if (command === 'show' && args[1] && args[1].toLowerCase() === 'dp') {
                showDp = true;
                generatePlayerList();
            } else if (command === 'no' && args[1] && args[1].toLowerCase() === 'dp') {
                dpMode = false;
                alert('Mode DP désactivé.');
            } else if (command === 'no' && args[1] && args[1].toLowerCase() === 'show' && args[2] && args[2].toLowerCase() === 'dp') {
                showDp = false;
                generatePlayerList();
            } else if (command === 'change' && args[1] && args[1].toLowerCase() === 'dp') {
                if (args.length >= 4) {
                    const playerName = args[2];
                    const newDp = parseInt(args[3], 10);
                    if (!isNaN(newDp)) {
                        const player = players.find(p => p.name.toLowerCase() === playerName.toLowerCase());
                        if (player) {
                            player.dp = newDp;
                            alert(`DP de ${player.name} mis à jour à ${newDp}.`);
                            if (showDp) {
                                generatePlayerList();
                            }
                        } else {
                            alert(`Joueur ${playerName} non trouvé.`);
                        }
                    } else {
                        alert('Veuillez spécifier une valeur numérique pour le DP.');
                    }
                } else {
                    alert('Usage : change dp NomDuJoueur NouvelleValeurDP');
                }
            } else if (command === 'no' && args[1] && args[1].toLowerCase() === 'change' && args[2] && args[2].toLowerCase() === 'dp') {
                players.forEach(player => {
                    player.dp = defaultDpValues[player.name];
                });
                alert('Les DP ont été réinitialisés aux valeurs par défaut.');
                if (showDp) {
                    generatePlayerList();
                }
            } else if (command === 'add') {
                if (args.length >= 3) {
                    const name = args[1];
                    const mainRole = args[2].toUpperCase();
                    let secondaryRole = null;
                    let dp = 0;

                    if (['DPS', 'HEAL', 'TANK'].includes(mainRole)) {
                        if (args.length >= 4 && ['DPS', 'HEAL', 'TANK'].includes(args[3].toUpperCase())) {
                            secondaryRole = args[3].toUpperCase();
                            if (args.length >= 5 && !isNaN(parseInt(args[4], 10))) {
                                dp = parseInt(args[4], 10);
                            }
                        } else if (args.length >= 4 && !isNaN(parseInt(args[3], 10))) {
                            dp = parseInt(args[3], 10);
                        }
                        players.push({name, mainRole, secondaryRole, dp});
                        defaultDpValues[name] = dp;
                        alert(`Joueur ${name} ajouté avec le rôle ${mainRole}${secondaryRole ? ' et le rôle secondaire ' + secondaryRole : ''}${dp ? ' et ' + dp + ' DP' : ''}.`);
                        generatePlayerList();
                    } else {
                        alert('Rôle principal invalide. Utilisez DPS, HEAL ou TANK.');
                    }
                } else {
                    alert('Usage : add NomDuJoueur RôlePrincipal [RôleSecondaire] [DP]');
                }
            } else {
                alert('Commande non reconnue.');
            }
            event.target.value = '';
        }
    }
</script>

</body>
</html>
