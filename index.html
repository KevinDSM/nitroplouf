<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NITROPLOUF</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <!-- La ligne de favicon a été supprimée pour éviter l'erreur -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Votre CSS reste inchangé */
        /* ... (gardez le même code CSS que précédemment) ... */
    </style>
</head>
<body>

<div class="mode-buttons">
    <button id="toggleDarkMode" onclick="toggleDarkMode()"></button>
    <button id="toggleGirlMode" onclick="toggleGirlMode()"></button>
</div>

<h1>NITROPLOUF</h1>

<div class="options-container">
    <label><input type="checkbox" id="showRioCheckbox" onchange="toggleShowRio()"> RIO</label>
    <label><input type="checkbox" id="equilibrateCheckbox"> Équilibre</label>
    <label><input type="checkbox" id="addPlayerCheckbox" onchange="toggleAddPlayerForm()"> Ajouter</label>
    <label><input type="checkbox" id="gifsCheckbox"> Gifs</label>
</div>

<div id="addPlayerForm">
    <h3>Ajouter un joueur</h3>
    <input type="text" id="newPlayerName" placeholder="Nom du joueur">
    <select id="newPlayerRole">
        <option value="" disabled selected>Rôle principal</option>
        <option value="tank">TANK</option>
        <option value="healer">HEAL</option>
        <option value="dps">DPS</option>
    </select>
    <input type="number" id="newPlayerRio" placeholder="Score RIO (optionnel)">
    <button onclick="addNewPlayer()">Ajouter le joueur</button>
</div>

<div class="search-container">
    <input type="text" id="playerSearch" placeholder="Rechercher un joueur..." oninput="suggestPlayers()" autocomplete="off">
    <div id="suggestions"></div>
</div>

<div class="selected-players" id="selectedPlayers"></div>

<button class="btn" onclick="generateGroups()">Lancer le Plouf Plouf</button>

<div id="miguelContainer">
    <h3>Mode Miguel Activé</h3>
    <div class="search-container">
        <input type="text" id="miguelPlayerSearch" placeholder="Sélectionner un joueur..." oninput="suggestMiguelPlayers()" autocomplete="off">
        <div id="miguelSuggestions"></div>
    </div>
    <div id="miguelSelectedPlayers"></div>
    <button class="btn" onclick="validateMiguel()">Valider Miguel</button>
</div>

<div id="result"></div>

<div id="upcomingFeatures">
    <h2>Prochaines fonctionnalités</h2>
    <ul>
        <li>Sons personnalisés</li>
        <li>Une section "trend" pour les retardataires qui n'ont jamais les références</li>
        <li>Et bien plus encore</li>
    </ul>
</div>

<div id="contactMessage">
    Contactez Houine pour avoir le lien PayPal pour m'aider dans mon projet (minimum 50 euros)
</div>

<a id="downloadLink" href="https://drive.google.com/file/d/19ko5ZBbUlOZySxhzHeRAH6Hp256wWARt/view" target="_blank">Télécharger Houineaura</a>

<script>
    let guildMembers = [];
    let selectedPlayers = [];
    let showDp = false;
    let miguelMode = false;
    let miguelPlayers = [];
    let darkMode = false;
    let girlMode = false;

    const classColors = {
        "Death Knight": "#C41F3B",
        "Demon Hunter": "#A330C9",
        "Druid": "#FF7D0A",
        "Hunter": "#ABD473",
        "Mage": "#69CCF0",
        "Monk": "#00FF96",
        "Paladin": "#F58CBA",
        "Priest": "#FFFFFF",
        "Rogue": "#FFF569",
        "Shaman": "#0070DE",
        "Warlock": "#9482C9",
        "Warrior": "#C79C6E",
        "Evoker": "#33937F",
        "Unknown": "#000000"
    };

    function normalizeName(name) {
        return name.replace(/\s+/g, '');
    }

    // Fonction pour normaliser les rôles
    function normalizeRole(role) {
        if (!role) return 'unknown';
        role = role.toLowerCase();
        if (role === 'heal') return 'healer';
        return role;
    }

    async function fetchGuildMembers() {
        try {
            const guildName = 'Nitroglycérhum';
            const encodedGuildName = encodeURIComponent(guildName);
            const response = await fetch(`https://raider.io/api/v1/guilds/profile?region=eu&realm=hyjal&name=${encodedGuildName}&fields=members`);
            if (response.ok) {
                const data = await response.json();
                const members = data.members.map(member => member.character);

                const detailedMembers = await Promise.all(members.map(async (character) => {
                    try {
                        const characterResponse = await fetch(`https://raider.io/api/v1/characters/profile?region=eu&realm=${encodeURIComponent(character.realm)}&name=${encodeURIComponent(character.name)}&fields=mythic_plus_scores_by_season:current,thumbnail_url,class,active_spec_role`);
                        if (characterResponse.ok) {
                            const characterData = await characterResponse.json();
                            const dpScore = characterData.mythic_plus_scores_by_season && characterData.mythic_plus_scores_by_season[0] && characterData.mythic_plus_scores_by_season[0].scores ? characterData.mythic_plus_scores_by_season[0].scores.all || 0 : 0;
                            const classColor = classColors[characterData.class] || "#000000";

                            let role = characterData.active_spec_role ? characterData.active_spec_role.toLowerCase() : 'unknown';
                            role = normalizeRole(role);

                            return {
                                name: characterData.name,
                                realName: characterData.name,
                                class: characterData.class || 'Unknown',
                                classColor: classColor,
                                role: role,
                                dp: Math.round(dpScore),
                                thumbnail_url: characterData.thumbnail_url || 'https://via.placeholder.com/100'
                            };
                        } else {
                            return null;
                        }
                    } catch (error) {
                        return null;
                    }
                }));

                const validMembers = detailedMembers.filter(member => member !== null);

                guildMembers = validMembers;

            } else {
                guildMembers = [];
            }
        } catch (error) {
            guildMembers = [];
        }
    }

    async function initialize() {
        await fetchGuildMembers();

        document.addEventListener('keydown', (event) => {
            if (event.key === '=' && !event.target.matches('input, textarea')) {
                toggleMiguelMode();
            }
        });

        // Définir les couleurs initiales des boutons
        document.getElementById('toggleDarkMode').style.backgroundColor = '#000000';
        document.getElementById('toggleGirlMode').style.backgroundColor = '#ffc0cb';
    }

    function toggleDarkMode() {
        darkMode = !darkMode;
        if (darkMode) {
            document.body.classList.add('dark-mode');
            document.body.classList.remove('girl-mode');
            girlMode = false;
            // Mettre à jour la couleur du bouton
            document.getElementById('toggleDarkMode').style.backgroundColor = '#ffffff'; // Blanc lorsqu'activé
            document.getElementById('toggleGirlMode').style.backgroundColor = '#ffc0cb'; // Réinitialiser le bouton du mode fille
        } else {
            document.body.classList.remove('dark-mode');
            document.getElementById('toggleDarkMode').style.backgroundColor = '#000000'; // Noir lorsqu'inactif
        }
    }

    function toggleGirlMode() {
        girlMode = !girlMode;
        if (girlMode) {
            document.body.classList.add('girl-mode');
            document.body.classList.remove('dark-mode');
            darkMode = false;
            // Mettre à jour la couleur du bouton
            document.getElementById('toggleGirlMode').style.backgroundColor = '#ffffff'; // Blanc lorsqu'activé
            document.getElementById('toggleDarkMode').style.backgroundColor = '#000000'; // Réinitialiser le bouton du mode sombre
        } else {
            document.body.classList.remove('girl-mode');
            document.getElementById('toggleGirlMode').style.backgroundColor = '#ffc0cb'; // Rose lorsqu'inactif
        }
    }

    function toggleShowRio() {
        showDp = document.getElementById('showRioCheckbox').checked;
        displaySelectedPlayers();
    }

    function toggleAddPlayerForm() {
        const form = document.getElementById('addPlayerForm');
        form.style.display = document.getElementById('addPlayerCheckbox').checked ? 'block' : 'none';
    }

    function suggestPlayers() {
        const input = document.getElementById('playerSearch').value.toLowerCase();
        const suggestionsDiv = document.getElementById('suggestions');
        suggestionsDiv.innerHTML = '';

        if (input.length === 0) {
            return;
        }

        const suggestions = guildMembers.filter(member => member.name.toLowerCase().includes(input) && !selectedPlayers.includes(member.name));

        suggestions.forEach(member => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';

            const img = document.createElement('img');
            img.src = member.thumbnail_url || 'https://via.placeholder.com/40';
            div.appendChild(img);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = member.name;
            nameSpan.style.color = member.classColor;
            div.appendChild(nameSpan);

            div.onclick = () => selectPlayer(member.name);
            suggestionsDiv.appendChild(div);
        });
    }

    function selectPlayer(playerName) {
        const player = guildMembers.find(member => member.name === playerName);
        if (player) {
            selectedPlayers.push(player.name);
            displaySelectedPlayers();
            document.getElementById('playerSearch').value = '';
            document.getElementById('suggestions').innerHTML = '';
        }
    }

    function displaySelectedPlayers() {
        const selectedPlayersDiv = document.getElementById('selectedPlayers');
        selectedPlayersDiv.innerHTML = '';

        selectedPlayers.forEach(playerName => {
            const player = guildMembers.find(member => member.name === playerName);

            const div = document.createElement('div');
            div.className = 'selected-player';

            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-player';
            removeBtn.textContent = '×';
            removeBtn.onclick = () => removePlayer(playerName);
            div.appendChild(removeBtn);

            const img = document.createElement('img');
            img.src = player.thumbnail_url || 'default.jpg';
            div.appendChild(img);

            const nameSpan = document.createElement('div');
            nameSpan.textContent = player.name;
            nameSpan.style.color = player.classColor || '#000000';
            nameSpan.style.fontWeight = 'bold';
            div.appendChild(nameSpan);

            const roleSpan = document.createElement('div');
            roleSpan.textContent = `Rôle : ${player.role}`;
            div.appendChild(roleSpan);

            if (showDp) {
                const dpSpan = document.createElement('div');
                dpSpan.textContent = `Score RIO : ${player.dp}`;
                div.appendChild(dpSpan);
            }

            selectedPlayersDiv.appendChild(div);
        });
    }

    function removePlayer(playerName) {
        selectedPlayers = selectedPlayers.filter(name => name !== playerName);
        displaySelectedPlayers();
    }

    function generateGroups() {
        if (selectedPlayers.length === 0) {
            alert('Veuillez sélectionner au moins un joueur.');
            return;
        }

        const equilibrate = document.getElementById('equilibrateCheckbox').checked;
        const useGifs = document.getElementById('gifsCheckbox').checked;

        const players = selectedPlayers.map(playerName => guildMembers.find(member => member.name === playerName));

        const tanks = players.filter(p => p.role === 'tank');
        const healers = players.filter(p => p.role === 'healer');
        const dps = players.filter(p => p.role === 'dps');

        const maxGroupSize = 5;
        const maxDpsPerGroup = 3;

        const numGroups = Math.max(
            Math.ceil(players.length / maxGroupSize),
            tanks.length,
            healers.length,
            Math.ceil(dps.length / maxDpsPerGroup)
        );

        const groups = [];
        for (let i = 0; i < numGroups; i++) {
            groups.push({
                Tank: null,
                Healer: null,
                DPS: [],
                totalDp: 0,
                members: []
            });
        }

        if (equilibrate) {
            players.sort((a, b) => b.dp - a.dp);
        } else {
            players.sort(() => Math.random() - 0.5);
        }

        if (miguelPlayers.length > 0) {
            const group = groups[0];
            miguelPlayers.forEach(playerName => {
                const player = players.find(p => p.name === playerName);
                if (player) {
                    if (player.role === 'tank' && !group.Tank) {
                        group.Tank = player;
                    } else if (player.role === 'healer' && !group.Healer) {
                        group.Healer = player;
                    } else {
                        group.DPS.push(player);
                    }
                    group.members.push(player);
                    group.totalDp += player.dp;
                    players.splice(players.indexOf(player), 1);
                }
            });
            miguelPlayers = [];
            miguelMode = false;
            document.getElementById('miguelContainer').style.display = 'none';
        }

        players.forEach(player => {
            let possibleGroups = groups.filter(group => {
                if (player.role === 'tank') {
                    return !group.Tank && group.members.length < maxGroupSize;
                } else if (player.role === 'healer') {
                    return !group.Healer && group.members.length < maxGroupSize;
                } else if (player.role === 'dps') {
                    return group.DPS.length < maxDpsPerGroup && group.members.length < maxGroupSize;
                }
                return group.members.length < maxGroupSize;
            });

            if (possibleGroups.length === 0) {
                groups.sort((a, b) => a.members.length - b.members.length);
                possibleGroups = [groups[0]];
            }

            if (equilibrate) {
                possibleGroups.sort((a, b) => a.totalDp - b.totalDp);
            } else {
                possibleGroups.sort(() => Math.random() - 0.5);
            }

            const group = possibleGroups[0];

            if (player.role === 'tank' && !group.Tank) {
                group.Tank = player;
            } else if (player.role === 'healer' && !group.Healer) {
                group.Healer = player;
            } else {
                group.DPS.push(player);
            }
            group.members.push(player);
            group.totalDp += player.dp;
        });

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';

        groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';

            const groupTitle = document.createElement('h3');
            groupTitle.textContent = `Groupe ${index + 1}`;
            groupDiv.appendChild(groupTitle);

            const playersDiv = document.createElement('div');
            playersDiv.className = 'group-players';

            group.members.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'group-player';

                const img = document.createElement('img');

                if (useGifs) {
                    const randomNumber = Math.floor(Math.random() * 5) + 1;
                    const playerNameNormalized = normalizeName(player.name);
                    img.src = `${playerNameNormalized}/${randomNumber}.gif`;
                    img.onerror = function() {
                        this.onerror = null;
                        this.src = player.thumbnail_url || 'default.jpg';
                    };
                } else {
                    img.src = player.thumbnail_url || 'default.jpg';
                }

                playerDiv.appendChild(img);

                const nameSpan = document.createElement('div');
                nameSpan.textContent = player.name;
                nameSpan.style.color = player.classColor;
                nameSpan.style.fontWeight = 'bold';
                playerDiv.appendChild(nameSpan);

                const roleSpan = document.createElement('div');
                roleSpan.textContent = `Rôle : ${player.role}`;
                playerDiv.appendChild(roleSpan);

                if (showDp) {
                    const dpSpan = document.createElement('div');
                    dpSpan.textContent = `Score RIO : ${player.dp}`;
                    playerDiv.appendChild(dpSpan);
                }

                playersDiv.appendChild(playerDiv);
            });

            groupDiv.appendChild(playersDiv);

            if (equilibrate) {
                const totalDpDiv = document.createElement('div');
                totalDpDiv.style.marginTop = '10px';
                totalDpDiv.innerHTML = `<strong>Total des scores RIO du groupe :</strong> ${group.totalDp}`;
                groupDiv.appendChild(totalDpDiv);
            }

            resultDiv.appendChild(groupDiv);
        });
    }

    function addNewPlayer() {
        const name = document.getElementById('newPlayerName').value.trim();
        const roleInput = document.getElementById('newPlayerRole').value;
        const role = normalizeRole(roleInput);
        const dp = parseInt(document.getElementById('newPlayerRio').value) || 0;

        if (!name || !roleInput) {
            alert('Veuillez renseigner au moins le nom et le rôle principal du joueur.');
            return;
        }

        if (guildMembers.some(member => member.name === name)) {
            alert('Un joueur avec ce nom existe déjà.');
            return;
        }

        const newPlayer = {
            name: name,
            realName: name,
            class: 'Unknown',
            classColor: classColors['Unknown'],
            role: role,
            dp: dp,
            thumbnail_url: 'default.jpg'
        };
        guildMembers.push(newPlayer);

        alert(`Joueur ${name} ajouté avec succès.`);

        selectedPlayers.push(name);
        displaySelectedPlayers();

        document.getElementById('newPlayerName').value = '';
        document.getElementById('newPlayerRole').value = '';
        document.getElementById('newPlayerRio').value = '';
    }

    function toggleMiguelMode() {
        miguelMode = !miguelMode;
        const miguelContainer = document.getElementById('miguelContainer');
        miguelContainer.style.display = miguelMode ? 'block' : 'none';
        miguelPlayers = [];
        document.getElementById('miguelSelectedPlayers').innerHTML = '';
        document.getElementById('miguelPlayerSearch').value = '';
        document.getElementById('miguelSuggestions').innerHTML = '';
    }

    function suggestMiguelPlayers() {
        const input = document.getElementById('miguelPlayerSearch').value.toLowerCase();
        const suggestionsDiv = document.getElementById('miguelSuggestions');
        suggestionsDiv.innerHTML = '';

        if (input.length === 0 || miguelPlayers.length >= 5) {
            return;
        }

        const suggestions = guildMembers.filter(member => member.name.toLowerCase().includes(input) && !miguelPlayers.includes(member.name));

        suggestions.forEach(member => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';

            const img = document.createElement('img');
            img.src = member.thumbnail_url || 'https://via.placeholder.com/40';
            div.appendChild(img);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = member.name;
            nameSpan.style.color = member.classColor;
            div.appendChild(nameSpan);

            div.onclick = () => selectMiguelPlayer(member.name);
            suggestionsDiv.appendChild(div);
        });
    }

    function selectMiguelPlayer(playerName) {
        if (miguelPlayers.length >= 5) {
            alert('Vous ne pouvez pas ajouter plus de 5 joueurs en mode Miguel.');
            return;
        }
        miguelPlayers.push(playerName);
        displayMiguelPlayers();
        document.getElementById('miguelPlayerSearch').value = '';
        document.getElementById('miguelSuggestions').innerHTML = '';
    }

    function displayMiguelPlayers() {
        const miguelSelectedDiv = document.getElementById('miguelSelectedPlayers');
        miguelSelectedDiv.innerHTML = '';

        miguelPlayers.forEach(playerName => {
            const player = guildMembers.find(member => member.name === playerName);

            const div = document.createElement('div');
            div.className = 'miguel-player';

            const img = document.createElement('img');
            img.src = player.thumbnail_url || 'https://via.placeholder.com/40';
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            div.appendChild(img);

            const nameSpan = document.createElement('div');
            nameSpan.textContent = player.name;
            nameSpan.style.color = player.classColor;
            nameSpan.style.fontSize = '14px';
            nameSpan.style.marginTop = '5px';
            div.appendChild(nameSpan);

            miguelSelectedDiv.appendChild(div);
        });
    }

    function validateMiguel() {
        if (miguelPlayers.length === 0) {
            alert('Veuillez sélectionner au moins un joueur pour le mode Miguel.');
            return;
        }

        miguelPlayers.forEach(playerName => {
            if (!selectedPlayers.includes(playerName)) {
                selectedPlayers.push(playerName);
            }
        });
        displaySelectedPlayers();
    }

    initialize();
</script>

</body>
</html>
